<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Güvenlik Yönetim Sistemi</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
        .event-types-pager { display: flex; align-items: center; gap: 8px; }
        .event-types-pager .chip-checkbox-group { flex: 1; display: flex; flex-wrap: wrap; gap: 12px; }
        .pager-btn { 
            background: rgba(0,0,0,0.05); 
            border: 1px solid rgba(0,0,0,0.1); 
            width: 32px; height: 32px; 
            border-radius: 8px; 
            font-size: 20px; 
            line-height: 30px; 
            text-align: center; 
            cursor: pointer; 
            user-select: none;
        }
        .pager-btn:disabled { opacity: .4; cursor: default; }
        /* Smooth transition */
        #eventCategoriesGroup { transition: opacity 180ms ease, transform 180ms ease; }
        /* Admin add button styled like a chip */
        .add-category-btn {
            background: transparent;
            border: 1px solid rgba(0,0,0,0.12);
            border-radius: 999px;
            padding: 8px 14px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .add-category-btn img { width: 18px; height: 18px; object-fit: contain; display: block; }
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.45); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { width: min(520px, 92vw); background: #fff; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,.25); overflow: hidden; transform: translateY(10px); opacity: 0; transition: opacity .18s ease, transform .18s ease; }
        .modal.open { transform: translateY(0); opacity: 1; }
        .modal-header { padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,.06); display: flex; align-items: center; justify-content: space-between; }
        .modal-title { font-size: 16px; font-weight: 700; }
        .modal-close { background: transparent; border: none; font-size: 22px; cursor: pointer; line-height: 1; }
        .modal-body { padding: 18px 20px; display: grid; gap: 12px; }
        .modal-actions { padding: 14px 20px 18px; display: flex; gap: 10px; justify-content: flex-end; }
        .btn-primary { background: #0d6efd; color: #fff; border: none; padding: 10px 14px; border-radius: 10px; cursor: pointer; }
        .btn-secondary { background: #f3f4f6; color: #111827; border: 1px solid #e5e7eb; padding: 10px 14px; border-radius: 10px; cursor: pointer; }
        .modal-input { width: 100%; border: 1px solid #e5e7eb; border-radius: 10px; padding: 10px 12px; font-size: 14px; }
    </style>
</head>
<body data-logged-in="{{ 1 if session.user_id else 0 }}" data-login-url="{{ url_for('login') }}" data-profile-url="{{ url_for('profile') }}">
    <!-- Navbar -->
    {% include '_navbar.html' %}

    <!-- Ana İçerik -->
    <main class="main-content">
        <section class="event-report-container">
            <div class="event-report-header">
                <h1>Olay Bildirimi</h1>
                <p>Gerçekleşen güvenlik olayını detaylarıyla birlikte hızlıca bildirin.</p>
            </div>

            {% if not session.user_id %}
            <div class="alert alert-error" role="alert">
                Olay bildirimi göndermek için lütfen giriş yapın.
            </div>
            {% endif %}

            <form id="eventReportForm" class="event-form" autocomplete="off">
                <div class="form-row">
                    <div class="form-field">
                        <label class="form-label">Departman</label>
                        <div class="chip-checkbox-group" data-group="department">
                            <label class="chip-checkbox">
                                <input type="checkbox" name="department" value="A">
                                <span>A</span>
                            </label>
                            <label class="chip-checkbox">
                                <input type="checkbox" name="department" value="B">
                                <span>B</span>
                            </label>
                            <label class="chip-checkbox">
                                <input type="checkbox" name="department" value="C">
                                <span>C</span>
                            </label>
                        </div>
                        <small class="hint">Bir departman seçin</small>
                    </div>

                    <div class="form-field">
                        <label class="form-label">Olay Türü</label>
                        <div class="event-types-pager">
                            <button type="button" id="eventPrevBtn" class="pager-btn" aria-label="Önceki" disabled>‹</button>
                            <div class="chip-checkbox-group" id="eventCategoriesGroup" data-group="event_type"></div>
                            <button type="button" id="eventNextBtn" class="pager-btn" aria-label="Sonraki" disabled>›</button>
                        </div>
                        <small class="hint">Bir veya birden fazla olay türü seçebilirsiniz</small>
                    </div>
                </div>

                <div class="form-field">
                    <label for="location" class="form-label">Olay Yeri</label>
                    <input type="text" id="location" name="location" class="form-input" placeholder="Olayın gerçekleştiği yer" required>
                </div>

                <div class="form-field">
                    <label for="details" class="form-label">Olay Detayları</label>
                    <textarea id="details" name="details" class="details-textarea" rows="6" placeholder="Olayın nasıl gerçekleştiği, etkilenen kişiler, alınan önlemler, hasar durumu gibi detayları yazın..."></textarea>
                </div>

                <div class="form-field">
                    <label for="witnesses" class="form-label">Tanıklar (Varsa)</label>
                    <div class="witnesses-input-container">
                        <input type="text" id="witnesses" name="witnesses" class="form-input" placeholder="Olayı gören kişilerin isimleri" autocomplete="off">
                        <div id="witnesses-suggestions" class="witnesses-suggestions" style="display: none;"></div>
                    </div>
                </div>

                <div class="form-field">
                    <label class="form-label">Fotoğraflar (maks. 5)</label>
                    <div class="image-uploader">
                        <input id="imageInput" type="file" accept="image/*" capture="environment" multiple style="display:none">
                        <div id="imageGrid" class="image-grid"></div>
                        <button type="button" id="addImageBtn" class="add-image-btn" aria-label="Fotoğraf Ekle">+</button>
                    </div>
                    <small class="hint">Cihazınızdan yükleyebilir ya da kamerayla fotoğraf çekebilirsiniz.</small>
                </div>

                <div class="form-actions">
                    <button type="submit" class="submit-btn">Olay Raporunu Gönder</button>
                </div>
            </form>
        </section>
    </main>

    <!-- Admin Bildirim Penceresi -->
    {% if session.user_id %}
    <div id="notification-container" class="notification-container" style="display: none;">
        <div class="notification-modal">
            <div class="notification-header">
                <div class="notification-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L13.09 8.26L20 9L13.09 9.74L12 16L10.91 9.74L4 9L10.91 8.26L12 2Z" fill="#FF6B6B"/>
                    </svg>
                </div>
                <h3 class="notification-title">Yeni Acil Yardım Sinyali!</h3>
                <button class="notification-close" onclick="closeNotification()">×</button>
            </div>
            <div class="notification-content">
                <div class="notification-item">
                    <span class="notification-label">Rapor Türü:</span>
                    <span class="notification-value" id="report-type"></span>
                </div>
                <div class="notification-item">
                    <span class="notification-label">Raporu Gönderen:</span>
                    <span class="notification-value" id="reporter-name"></span>
                </div>
                <div class="notification-item">
                    <span class="notification-label">Tarih:</span>
                    <span class="notification-value" id="report-date"></span>
                </div>
            </div>
            <div class="notification-actions">
                <button class="notification-btn primary" onclick="viewReport()">Raporu Görüntüle</button>
                <button class="notification-btn secondary" onclick="closeNotification()">Kapat</button>
            </div>
        </div>
    </div>

    {% if session.is_admin %}
    <!-- Debug Butonu (Sadece admin için) -->
    <div class="debug-btn" onclick="debugReports()" title="Debug Raporları">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2L2 7L12 12L22 7L12 2Z" fill="white"/>
            <path d="M2 17L12 22L22 17" fill="white"/>
            <path d="M2 12L12 17L22 12" fill="white"/>
        </svg>
    </div>
    {% endif %}
    {% endif %}

    {% if session.is_admin %}
    <!-- Olay Türü Ekle Modal -->
    <div id="eventAddModalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal" id="eventAddModal">
            <div class="modal-header">
                <div class="modal-title">Yeni Olay Türü Ekle</div>
                <button class="modal-close" id="eventAddModalClose" aria-label="Kapat">×</button>
            </div>
            <div class="modal-body">
                <label for="eventAddInput">Olay türü adı</label>
                <input id="eventAddInput" class="modal-input" type="text" placeholder="Örn: Elektrikle Temas">
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" id="eventAddCancel">İptal</button>
                <button class="btn-primary" id="eventAddSave">Ekle</button>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // Shared UI
        SharedUI.initNavbarUI();

        // Smooth scroll için
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Profile buton tıklama işlemi
        function handleProfileClick() { SharedUI.initProfileButton(); }

        // Olay formu etkileşimleri
        (function initEventForm() {
            const form = document.getElementById('eventReportForm');
            if (!form) return;

            // Çoklu seçim için checkbox davranışı (tüm seçenekler seçilebilir)
            // Artık tek seçimli davranış yok, kullanıcı istediği kadar seçebilir

            // Tanık autocomplete özelliği
            initWitnessesAutocomplete();

            // Görsel yükleme
            const addBtn = document.getElementById('addImageBtn');
            const fileInput = document.getElementById('imageInput');
            const grid = document.getElementById('imageGrid');
            const MAX_FILES = 5;
            let files = [];

            function refreshGrid() {
                grid.innerHTML = '';
                files.forEach((file, index) => {
                    const url = URL.createObjectURL(file);
                    const item = document.createElement('div');
                    item.className = 'image-item';
                    const img = document.createElement('img');
                    img.src = url;
                    img.alt = 'Yüklenen görsel ' + (index + 1);
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-image-btn';
                    removeBtn.type = 'button';
                    removeBtn.textContent = '×';
                    removeBtn.setAttribute('aria-label', 'Görseli kaldır');
                    removeBtn.addEventListener('click', () => {
                        URL.revokeObjectURL(url);
                        files.splice(index, 1);
                        refreshGrid();
                    });
                    item.appendChild(img);
                    item.appendChild(removeBtn);
                    grid.appendChild(item);
                });
                addBtn.disabled = files.length >= MAX_FILES;
            }

            addBtn.addEventListener('click', () => {
                fileInput.value = '';
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                const selected = Array.from(e.target.files || []);
                for (const f of selected) {
                    if (files.length >= MAX_FILES) break;
                    if (/^image\//.test(f.type)) {
                        files.push(f);
                    }
                }
                refreshGrid();
            });

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const department = form.querySelector('input[name="department"]:checked');
                const eventTypes = form.querySelectorAll('input[name="event_type"]:checked');
                const location = document.getElementById('location').value.trim();
                const details = document.getElementById('details').value.trim();
                const witnesses = document.getElementById('witnesses').value.trim();

                if (!department) {
                    alert('Lütfen bir departman seçin.');
                    return;
                }
                if (eventTypes.length === 0) {
                    alert('Lütfen en az bir olay türü seçin.');
                    return;
                }
                if (!location) {
                    alert('Lütfen olay yerini belirtin.');
                    return;
                }
                if (details.length < 5) {
                    alert('Lütfen olay detaylarını daha açıklayıcı yazın.');
                    return;
                }

                const fd = new FormData();
                fd.append('department', department.value);
                // Birden fazla olay türü seçilebilir
                eventTypes.forEach(eventType => {
                    fd.append('event_type[]', eventType.value);
                });
                fd.append('location', location);
                fd.append('details', details);
                //22.01.2026
                witnesses = document.getElementById('witnesses').value.trim();
                fd.append('witnesses', witnesses);
                files.forEach((file) => fd.append('images[]', file));

                try {
                    const resp = await fetch('/submit-event-report', {
                        method: 'POST',
                        body: fd
                    });
                    if (resp.status === 401) {
                        alert('Rapor göndermek için lütfen giriş yapın.');
                        window.location.href = "{{ url_for('login') }}";
                        return;
                    }
                    const data = await resp.json();
                    if (data.success) {
                        alert('Olay raporunuz başarıyla gönderildi. Teşekkürler.');
                        form.reset();
                        files = [];
                        refreshGrid();
                    } else {
                        alert('Hata: ' + (data.message || 'Rapor gönderilemedi'));
                    }
                } catch (err) {
                    alert('Ağ hatası: ' + err.message);
                }
            });

            refreshGrid();

            // Kategorileri yükle
            let allEventTypes = [];
            let currentEventPage = 0;
            const PAGE_SIZE = 4;

            function renderEventPage() {
                const container = document.getElementById('eventCategoriesGroup');
                container.style.opacity = '0';
                container.style.transform = 'translateY(6px)';
                setTimeout(() => {
                    container.innerHTML = '';
                const start = currentEventPage * PAGE_SIZE;
                const pageItems = allEventTypes.slice(start, start + PAGE_SIZE);
                pageItems.forEach((name) => {
                    const label = document.createElement('label');
                    label.className = 'chip-checkbox';
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.name = 'event_type';
                    input.value = name;
                    const span = document.createElement('span');
                    span.textContent = name;
                    label.appendChild(input);
                    label.appendChild(span);
                    container.appendChild(label);
                });
                    // Admin inline add button at end of each page
                    const IS_ADMIN = {{ 'true' if session.is_admin else 'false' }};
                    if (IS_ADMIN) {
                        const actionsWrap = document.createElement('div');
                        actionsWrap.style.display = 'inline-flex';
                        actionsWrap.style.gap = '8px';

                        const addBtn = document.createElement('button');
                        addBtn.type = 'button';
                        addBtn.className = 'add-category-btn';
                        addBtn.title = 'Yeni olay türü ekle';
                        addBtn.setAttribute('aria-label', 'Yeni olay türü ekle');
                        const img = document.createElement('img');
                        img.src = '{{ url_for('static', filename='images/addEventRisk.png') }}';
                        img.alt = 'Ekle';
                        addBtn.appendChild(img);
                        addBtn.addEventListener('click', () => openEventAddModal());
                        actionsWrap.appendChild(addBtn);

                        const delBtn = document.createElement('button');
                        delBtn.type = 'button';
                        delBtn.className = 'add-category-btn';
                        delBtn.title = 'Seçili olay tür(ler)ini sil';
                        delBtn.setAttribute('aria-label', 'Seçili olay tür(ler)ini sil');
                        const delImg = document.createElement('img');
                        delImg.src = '{{ url_for('static', filename='images/deleteEventRisk.png') }}';
                        delImg.alt = 'Sil';
                        delBtn.appendChild(delImg);
                        delBtn.addEventListener('click', async () => {
                            // mevcut sayfadaki seçili event_type değerlerini al
                            const checked = Array.from(container.querySelectorAll('input[name="event_type"]:checked')).map(i => i.value);
                            if (checked.length === 0) { alert('Silmek için en az bir olay türü seçin.'); return; }
                            if (!confirm('Seçili olay tür(ler)ini silmek istediğinize emin misiniz?')) return;
                            try {
                                const resp = await fetch('/api/categories/bulk-delete', {
                                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ type: 'event', names: checked })
                                });
                                const data = await resp.json();
                                if (data.success) { await loadEventCategories(); }
                                else { alert('Hata: ' + (data.message || 'Silinemedi')); }
                            } catch (e) { alert('Ağ hatası: ' + e.message); }
                        });
                        actionsWrap.appendChild(delBtn);

                        container.appendChild(actionsWrap);
                    }
                    const prevBtn = document.getElementById('eventPrevBtn');
                    const nextBtn = document.getElementById('eventNextBtn');
                    const totalPages = Math.ceil(allEventTypes.length / PAGE_SIZE) || 1;
                    prevBtn.disabled = currentEventPage <= 0;
                    nextBtn.disabled = currentEventPage >= totalPages - 1;
                    // fade in
                    requestAnimationFrame(() => {
                        container.style.opacity = '1';
                        container.style.transform = 'translateY(0)';
                    });
                }, 100);
            }

            async function loadEventCategories() {
                try {
                    const resp = await fetch('/api/categories?type=event');
                    const data = await resp.json();
                    if (!data.success) return;
                    allEventTypes = data.items || [];
                    currentEventPage = 0;
                    renderEventPage();
                } catch (e) { /* sessiz */ }
            }
            loadEventCategories();

            // Modal helpers (admin)
            function openEventAddModal() {
                const overlay = document.getElementById('eventAddModalOverlay');
                const modal = document.getElementById('eventAddModal');
                overlay.style.display = 'flex';
                requestAnimationFrame(() => modal.classList.add('open'));
                const input = document.getElementById('eventAddInput');
                input.value = '';
                setTimeout(() => input.focus(), 50);
            }
            function closeEventAddModal() {
                const overlay = document.getElementById('eventAddModalOverlay');
                const modal = document.getElementById('eventAddModal');
                modal.classList.remove('open');
                setTimeout(() => overlay.style.display = 'none', 150);
            }
            const eventAddSave = document.getElementById('eventAddSave');
            const eventAddCancel = document.getElementById('eventAddCancel');
            const eventAddClose = document.getElementById('eventAddModalClose');
            if (eventAddSave) {
                eventAddSave.addEventListener('click', async () => {
                    const name = document.getElementById('eventAddInput').value.trim();
                    if (!name) return;
                    try {
                        const resp = await fetch('/api/categories', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ type: 'event', name })
                        });
                        const data = await resp.json();
                        if (data.success) {
                            closeEventAddModal();
                            await loadEventCategories();
                        } else {
                            alert('Hata: ' + (data.message || 'Eklenemedi'));
                        }
                    } catch (err) { alert('Ağ hatası: ' + err.message); }
                });
            }
            if (eventAddCancel) eventAddCancel.addEventListener('click', closeEventAddModal);
            if (eventAddClose) eventAddClose.addEventListener('click', closeEventAddModal);

            // Sayfalama butonları
            const prevBtn = document.getElementById('eventPrevBtn');
            const nextBtn = document.getElementById('eventNextBtn');
            if (prevBtn && nextBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentEventPage > 0) {
                        currentEventPage -= 1;
                        renderEventPage();
                    }
                });
                nextBtn.addEventListener('click', () => {
                    const totalPages = Math.ceil(allEventTypes.length / PAGE_SIZE) || 1;
                    if (currentEventPage < totalPages - 1) {
                        currentEventPage += 1;
                        renderEventPage();
                    }
                });
            }
        })();

        // Admin bildirim sistemi
        let notificationCheckInterval;
        let lastCheckTime = new Date();

        function closeNotification() {
            const container = document.getElementById('notification-container');
            container.style.display = 'none';
        }

        function viewReport() {
            window.location.href = "{{ url_for('raporlar') }}";
        }

        function checkNewReports() { /* handled in SharedUI.maybeInitAdminNotifications */ }

        function showNotification(report) {
            document.getElementById('report-type').textContent = report.type;
            document.getElementById('reporter-name').textContent = report.reporter_name;
            document.getElementById('report-date').textContent = new Date(report.date).toLocaleString('tr-TR');
            const container = document.getElementById('notification-container');
            container.style.display = 'flex';
            playNotificationSound();
        }

        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT');
                audio.play();
            } catch (e) {
                console.log('Ses çalınamadı:', e);
            }
        }

        function initAdminNotifications() { SharedUI.maybeInitAdminNotifications(); }

        function debugReports() { SharedUI.debugReports(); }

        document.addEventListener('DOMContentLoaded', function() {
            const body = document.body;
            const loggedIn = body.dataset.loggedIn === '1';
            if (loggedIn) {
                fetch('/check-admin-status')
                    .then(response => response.json())
                    .then(data => {
                        if (data.is_admin) {
                            initAdminNotifications();
                        }
                    })
                    .catch(error => {
                        console.error('Admin kontrolü hatası:', error);
                    });
            }
        });

        window.addEventListener('beforeunload', function() {
            if (notificationCheckInterval) {
                clearInterval(notificationCheckInterval);
            }
        });

        // Tanık autocomplete fonksiyonu
        function initWitnessesAutocomplete() {
            const witnessesInput = document.getElementById('witnesses');
            const suggestionsContainer = document.getElementById('witnesses-suggestions');
            let currentSuggestions = [];
            let selectedIndex = -1;
            let searchTimeout;

            // Input'a yazıldığında
            witnessesInput.addEventListener('input', function(e) {
                const fullValue = e.target.value.trim();
                
                // Önceki timeout'u temizle
                clearTimeout(searchTimeout);
                
                // Virgülle böl ve son kısmını al (arama metni)
                const parts = fullValue.split(',');
                const searchQuery = parts[parts.length - 1].trim();
                
                if (searchQuery.length < 2) {
                    hideSuggestions();
                    return;
                }

                // 300ms gecikme ile arama yap (her tuş vuruşunda değil)
                searchTimeout = setTimeout(() => {
                    searchUsers(searchQuery);
                }, 300);
            });

            // Klavye navigasyonu
            witnessesInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    
                    if (suggestionsContainer.style.display === 'none') {
                        // Öneriler kapalıysa virgül ekle
                        const currentValue = witnessesInput.value.trim();
                        if (currentValue !== '') {
                            const lastChar = currentValue.slice(-1);
                            if (lastChar !== ',') {
                                witnessesInput.value = currentValue + ', ';
                                witnessesInput.setSelectionRange(currentValue.length + 2, currentValue.length + 2);
                            }
                        }
                    } else {
                        // Öneriler açıksa seçili öneriyi seç
                        selectCurrent();
                    }
                    return;
                }

                if (suggestionsContainer.style.display === 'none') {
                    return;
                }

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        selectNext();
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        selectPrevious();
                        break;
                    case 'Escape':
                        hideSuggestions();
                        break;
                }
            });

            // Input'tan çıkıldığında
            witnessesInput.addEventListener('blur', function() {
                // Mouse ile tıklama için biraz gecikme
                setTimeout(() => {
                    if (!suggestionsContainer.matches(':hover')) {
                        hideSuggestions();
                    }
                }, 150);
            });

            // Kullanıcı arama fonksiyonu
            async function searchUsers(query) {
                try {
                    const response = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        currentSuggestions = data.users;
                        showSuggestions();
                    }
                } catch (error) {
                    console.error('Kullanıcı arama hatası:', error);
                }
            }

            // Önerileri göster
            function showSuggestions() {
                if (currentSuggestions.length === 0) {
                    hideSuggestions();
                    return;
                }

                suggestionsContainer.innerHTML = '';
                selectedIndex = -1;

                currentSuggestions.forEach((user, index) => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'suggestion-item';
                    suggestionItem.textContent = user.fullname;
                    suggestionItem.dataset.fullname = user.fullname;
                    
                    suggestionItem.addEventListener('click', function() {
                        selectSuggestion(user.fullname);
                    });

                    suggestionItem.addEventListener('mouseenter', function() {
                        selectedIndex = index;
                        updateSelection();
                    });

                    suggestionsContainer.appendChild(suggestionItem);
                });

                suggestionsContainer.style.display = 'block';
            }

            // Önerileri gizle
            function hideSuggestions() {
                suggestionsContainer.style.display = 'none';
                currentSuggestions = [];
                selectedIndex = -1;
            }

            // Sonraki öneriyi seç
            function selectNext() {
                if (selectedIndex < currentSuggestions.length - 1) {
                    selectedIndex++;
                } else {
                    selectedIndex = 0;
                }
                updateSelection();
            }

            // Önceki öneriyi seç
            function selectPrevious() {
                if (selectedIndex > 0) {
                    selectedIndex--;
                } else {
                    selectedIndex = currentSuggestions.length - 1;
                }
                updateSelection();
            }

            // Seçimi güncelle
            function updateSelection() {
                const items = suggestionsContainer.querySelectorAll('.suggestion-item');
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === selectedIndex);
                });
            }

            // Mevcut seçimi uygula
            function selectCurrent() {
                if (selectedIndex >= 0 && selectedIndex < currentSuggestions.length) {
                    const selectedUser = currentSuggestions[selectedIndex];
                    selectSuggestion(selectedUser.fullname);
                }
            }

            // Öneriyi seç
            function selectSuggestion(fullname) {
                const currentValue = witnessesInput.value.trim();
                let newValue;
                
                // Mevcut değeri virgülle böl
                const parts = currentValue.split(',');
                
                if (parts.length === 1) {
                    // Sadece bir kısım varsa (virgül yoksa), direkt değiştir ve virgül ekle
                    newValue = fullname + ', ';
                } else {
                    // Birden fazla kısım varsa, son kısmı hariç tut ve yeni ismi ekle
                    const existingNames = parts.slice(0, -1).join(',').trim();
                    newValue = existingNames + ', ' + fullname + ', ';
                }
                
                witnessesInput.value = newValue;
                hideSuggestions();
                witnessesInput.focus();
                
                // Cursor'u sona taşı
                witnessesInput.setSelectionRange(newValue.length, newValue.length);
            }
        }
    
    </script>
</body>
</html> 